name: QA Automation - Accessibility & Usability

# This workflow uses NO github.event.* inputs in run commands
# All values are static - no command injection risk

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    - cron: '0 2 * * *'

jobs:
  accessibility-audit:
    name: WCAG 2.2 Accessibility Audit
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: |
          npm install -g @axe-core/cli pa11y lighthouse
          python3 -m http.server 8000 &
          sleep 5

      - name: Run axe-core accessibility tests
        run: |
          axe http://localhost:8000 \
            --rules wcag2a,wcag2aa,wcag21aa,wcag22aa \
            --exit \
            --save axe-results.json
        continue-on-error: true

      - name: Run Pa11y accessibility tests
        run: |
          pa11y http://localhost:8000 \
            --standard WCAG2AA \
            --reporter json \
            --threshold 0 > pa11y-results.json
        continue-on-error: true

      - name: Lighthouse accessibility score
        run: |
          lighthouse http://localhost:8000 \
            --output json \
            --output-path lighthouse-results.json \
            --only-categories=accessibility \
            --chrome-flags="--headless"

      - name: Check minimum accessibility score
        run: |
          SCORE=$(jq '.categories.accessibility.score * 100' lighthouse-results.json)
          echo "Accessibility Score: $SCORE"
          if (( $(echo "$SCORE < 90" | bc -l) )); then
            echo "Accessibility score is below 90%"
            exit 1
          fi
          echo "Accessibility score meets threshold"

      - name: Upload accessibility reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: accessibility-reports
          path: |
            axe-results.json
            pa11y-results.json
            lighthouse-results.json

  form-validation-tests:
    name: Form Validation & Labels
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Playwright
        run: |
          npm init -y
          npm install -D @playwright/test
          npx playwright install chromium

      - name: Create Playwright tests
        run: |
          cat > e2e-accessibility.spec.cjs << 'EOF'
          const { test, expect } = require('@playwright/test');

          test.describe('Form Accessibility Tests', () => {
            test.beforeEach(async ({ page }) => {
              await page.goto('http://localhost:8000');
            });

            test('All form inputs have associated labels', async ({ page }) => {
              const inputs = await page.locator('input').all();
              for (const input of inputs) {
                const id = await input.getAttribute('id');
                if (id) {
                  const label = await page.locator(`label[for="${id}"]`).count();
                  expect(label).toBeGreaterThan(0);
                }
              }
            });

            test('Error messages have ARIA live regions', async ({ page }) => {
              const errorContainers = await page.locator('[role="alert"]').all();
              expect(errorContainers.length).toBeGreaterThan(0);
            });

            test('Required fields have aria-required', async ({ page }) => {
              const requiredInputs = await page.locator('input[required]').all();
              for (const input of requiredInputs) {
                const ariaRequired = await input.getAttribute('aria-required');
                expect(ariaRequired).toBe('true');
              }
            });

            test('Modals are keyboard accessible', async ({ page }) => {
              await page.click('button:has-text("Get Started")');
              await page.waitForSelector('.modal', { timeout: 5000 });
              await page.keyboard.press('Escape');
            });
          });
          EOF

      - name: Start server
        run: |
          python3 -m http.server 8000 &
          sleep 5

      - name: Run Playwright tests
        run: npx playwright test e2e-accessibility.spec.cjs

      - name: Upload Playwright report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report
          path: playwright-report/

  keyboard-navigation-tests:
    name: Keyboard Navigation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for focus indicators
        run: |
          echo "Checking for focus styles in CSS..."
          grep -n ":focus" src/styles/*.css || echo "Warning: No focus styles found"

  html-validation:
    name: HTML5 Semantic Validation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check semantic HTML
        run: |
          echo "Checking for ARIA attributes..."
          grep -c "aria-" index.html || echo "No ARIA found"

          echo "Checking heading hierarchy..."
          grep -o "<h[1-6]" index.html | sort | uniq -c

          echo "Checking for alt text..."
          IMAGES=$(grep -c '<img' index.html || echo "0")
          ALT_TEXT=$(grep -c 'alt=' index.html || echo "0")
          echo "Images: $IMAGES, With alt: $ALT_TEXT"

  ncaa-compliance-check:
    name: NCAA Compliance Content Review
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check NCAA compliance keywords
        run: |
          echo "Checking NCAA compliance requirements..."
          grep -i "GPA\|academic\|scholar" index.html || echo "Warning: Academic emphasis not prominent"
          ! grep -i "pay for play\|performance bonus" index.html || echo "Error: Pay-for-play language detected"
          grep -i "verif" index.html || echo "Warning: Verification system not mentioned"
          echo "NCAA compliance checks complete"
