name: QA Automation - Accessibility & Usability

# This workflow uses NO github.event.* inputs in run commands
# All values are static - no command injection risk

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    - cron: '0 2 * * *'

jobs:
  accessibility-audit:
    name: WCAG 2.2 Accessibility Audit
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Chrome for Lighthouse
        uses: browser-actions/setup-chrome@v1
        with:
          chrome-version: stable

      - name: Install dependencies
        run: |
          npm install -g @axe-core/cli pa11y lighthouse

      - name: Start server
        run: |
          python3 -m http.server 8000 &
          sleep 5

      - name: Run axe-core accessibility tests
        run: |
          axe http://localhost:8000 \
            --rules wcag2a,wcag2aa,wcag21aa,wcag22aa \
            --exit \
            --save axe-results.json || true
        continue-on-error: true

      - name: Run Pa11y accessibility tests
        run: |
          pa11y http://localhost:8000 \
            --standard WCAG2AA \
            --reporter json \
            --threshold 10 > pa11y-results.json || true
        continue-on-error: true

      - name: Lighthouse accessibility score
        run: |
          lighthouse http://localhost:8000 \
            --output json \
            --output-path lighthouse-results.json \
            --only-categories=accessibility \
            --chrome-flags="--headless --no-sandbox --disable-gpu"
        continue-on-error: true

      - name: Check minimum accessibility score
        run: |
          if [ -f lighthouse-results.json ]; then
            SCORE=$(jq '.categories.accessibility.score * 100' lighthouse-results.json 2>/dev/null || echo "0")
            echo "Accessibility Score: $SCORE"
            if [ -z "$SCORE" ] || [ "$SCORE" = "null" ]; then
              echo "Warning: Could not parse accessibility score"
              exit 0
            fi
            if (( $(echo "$SCORE < 90" | bc -l) )); then
              echo "Accessibility score is below 90%"
              exit 1
            fi
            echo "Accessibility score meets threshold"
          else
            echo "Warning: Lighthouse results not found"
            exit 0
          fi

      - name: Upload accessibility reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: accessibility-reports
          path: |
            axe-results.json
            pa11y-results.json
            lighthouse-results.json
          if-no-files-found: ignore

  form-validation-tests:
    name: Form Validation & Labels
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Playwright
        run: |
          npm install -D @playwright/test
          npx playwright install chromium --with-deps

      - name: Create Playwright config
        run: |
          cat > playwright.config.js << 'CONFIGEOF'
          import { defineConfig } from '@playwright/test';

          export default defineConfig({
            testDir: '.',
            testMatch: '*.spec.js',
            timeout: 30000,
            use: {
              baseURL: 'http://localhost:8000',
              headless: true,
            },
            webServer: {
              command: 'python3 -m http.server 8000',
              url: 'http://localhost:8000',
              reuseExistingServer: false,
              timeout: 10000,
            },
          });
          CONFIGEOF

      - name: Create Playwright tests
        run: |
          cat > e2e-accessibility.spec.js << 'EOF'
          import { test, expect } from '@playwright/test';

          test.describe('Form Accessibility Tests', () => {
            test.beforeEach(async ({ page }) => {
              await page.goto('/');
              await page.waitForLoadState('domcontentloaded');
            });

            test('Page loads successfully', async ({ page }) => {
              const title = await page.title();
              expect(title).toBeTruthy();
            });

            test('Form inputs with IDs have associated labels', async ({ page }) => {
              const inputs = await page.locator('input[id]').all();
              let testedCount = 0;
              for (const input of inputs) {
                const id = await input.getAttribute('id');
                if (id) {
                  const hasLabel = await page.locator(`label[for="${id}"]`).count();
                  const hasAriaLabel = await input.getAttribute('aria-label');
                  const hasAriaLabelledBy = await input.getAttribute('aria-labelledby');
                  // Input should have label, aria-label, or aria-labelledby
                  const isAccessible = hasLabel > 0 || hasAriaLabel || hasAriaLabelledBy;
                  if (!isAccessible) {
                    console.log(`Warning: Input #${id} lacks accessible label`);
                  }
                  testedCount++;
                }
              }
              console.log(`Tested ${testedCount} form inputs`);
              expect(true).toBe(true); // Test passes as informational
            });

            test('Required fields have proper attributes', async ({ page }) => {
              const requiredInputs = await page.locator('input[required]').all();
              console.log(`Found ${requiredInputs.length} required fields`);
              expect(true).toBe(true); // Test passes as informational
            });

            test('Interactive elements are keyboard focusable', async ({ page }) => {
              // Press Tab to test keyboard navigation
              await page.keyboard.press('Tab');
              const focusedElement = await page.evaluate(() => document.activeElement?.tagName);
              console.log(`First focused element: ${focusedElement}`);
              expect(focusedElement).toBeTruthy();
            });
          });
          EOF

      - name: Run Playwright tests
        run: npx playwright test --reporter=list

      - name: Upload Playwright report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report
          path: test-results/
          if-no-files-found: ignore

  keyboard-navigation-tests:
    name: Keyboard Navigation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for focus indicators
        run: |
          echo "Checking for focus styles in CSS..."
          # Check main styles.css and any CSS in src/styles
          if [ -f "styles.css" ]; then
            grep -n ":focus" styles.css && echo "Focus styles found in styles.css" || echo "Warning: No focus styles found in styles.css"
          fi
          if [ -d "src/styles" ]; then
            find src/styles -name "*.css" -exec grep -l ":focus" {} \; 2>/dev/null || echo "No additional focus styles in src/styles"
          fi
          echo "Keyboard navigation check complete"

  html-validation:
    name: HTML5 Semantic Validation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check semantic HTML
        run: |
          echo "Checking for ARIA attributes..."
          ARIA_COUNT=$(grep -c "aria-" index.html 2>/dev/null || echo "0")
          echo "ARIA attributes found: $ARIA_COUNT"

          echo "Checking heading hierarchy..."
          grep -o "<h[1-6]" index.html 2>/dev/null | sort | uniq -c || echo "No headings found"

          echo "Checking for alt text..."
          IMAGES=$(grep -c '<img' index.html 2>/dev/null || echo "0")
          ALT_TEXT=$(grep -c 'alt=' index.html 2>/dev/null || echo "0")
          echo "Images: $IMAGES, With alt: $ALT_TEXT"

  ncaa-compliance-check:
    name: NCAA Compliance Content Review
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check NCAA compliance keywords
        run: |
          echo "Checking NCAA compliance requirements..."
          grep -i "GPA\|academic\|scholar" index.html && echo "Academic emphasis found" || echo "Warning: Academic emphasis not prominent"
          if grep -qi "pay for play\|performance bonus" index.html; then
            echo "Error: Pay-for-play language detected"
            exit 1
          fi
          grep -i "verif" index.html && echo "Verification system mentioned" || echo "Warning: Verification system not mentioned"
          echo "NCAA compliance checks complete"
