/**
 * Tests: Athlete Deals Page
 *
 * Tests cover:
 * - Page rendering and layout
 * - View toggle (table/kanban)
 * - Deal statistics
 * - Filtering and search
 * - Table view display
 * - Kanban view display
 * - Navigation to deal details
 * - Empty and error states
 */

import { render, screen, waitFor } from '@testing-library/react';
import userEvent from '@testing-library/user-event';
import AthleteDealsPage from '@/app/(dashboard)/athlete/deals/page';
import { ToastProvider } from '@/components/ui/toast';
import type { Deal } from '@/lib/services/deals';

// ═══════════════════════════════════════════════════════════════════════════
// Mock Data
// ═══════════════════════════════════════════════════════════════════════════

const mockDeals: Deal[] = [
  {
    id: 'deal-1',
    brand_id: 'brand-1',
    athlete_id: 'athlete-1',
    opportunity_id: null,
    title: 'Nike Social Campaign',
    description: 'Create 3 Instagram posts',
    deal_type: 'social_post',
    compensation_type: 'fixed',
    compensation_amount: 5000,
    status: 'active',
    start_date: '2026-01-10',
    end_date: '2026-03-10',
    created_at: '2026-01-10T10:00:00Z',
    brand: {
      company_name: 'Nike',
      logo_url: null,
    },
  },
  {
    id: 'deal-2',
    brand_id: 'brand-2',
    athlete_id: 'athlete-1',
    opportunity_id: null,
    title: 'Gatorade Event Appearance',
    description: 'Attend product launch',
    deal_type: 'appearance',
    compensation_type: 'fixed',
    compensation_amount: 2500,
    status: 'pending',
    start_date: '2026-02-01',
    end_date: '2026-02-15',
    created_at: '2026-02-01T10:00:00Z',
    brand: {
      company_name: 'Gatorade',
      logo_url: null,
    },
  },
  {
    id: 'deal-3',
    brand_id: 'brand-3',
    athlete_id: 'athlete-1',
    opportunity_id: null,
    title: 'Local Dealership Promo',
    description: 'Social media promotion',
    deal_type: 'endorsement',
    compensation_type: 'fixed',
    compensation_amount: 1500,
    status: 'completed',
    start_date: '2025-12-15',
    end_date: '2026-01-10',
    created_at: '2025-12-15T10:00:00Z',
    brand: {
      company_name: 'Durham Auto',
      logo_url: null,
    },
  },
  {
    id: 'deal-4',
    brand_id: 'brand-4',
    athlete_id: 'athlete-1',
    opportunity_id: null,
    title: 'Under Armour Partnership',
    description: 'Season-long endorsement',
    deal_type: 'endorsement',
    compensation_type: 'fixed',
    compensation_amount: 10000,
    status: 'negotiating',
    start_date: '2026-02-05',
    end_date: '2026-12-31',
    created_at: '2026-02-05T10:00:00Z',
    brand: {
      company_name: 'Under Armour',
      logo_url: null,
    },
  },
];

// ═══════════════════════════════════════════════════════════════════════════
// Mocks
// ═══════════════════════════════════════════════════════════════════════════

const mockPush = jest.fn();
const mockReplace = jest.fn();

jest.mock('next/navigation', () => ({
  useRouter: () => ({
    push: mockPush,
    replace: mockReplace,
    prefetch: jest.fn(),
    back: jest.fn(),
    forward: jest.fn(),
  }),
  usePathname: () => '/athlete/deals',
  useSearchParams: () => new URLSearchParams(),
}));

jest.mock('@/lib/supabase/client', () => ({
  createClient: jest.fn(() => ({
    auth: {
      getSession: jest.fn().mockResolvedValue({
        data: { session: { user: { id: 'athlete-1', email: 'athlete@example.com' } } },
      }),
      getUser: jest.fn().mockResolvedValue({
        data: { user: { id: 'athlete-1', email: 'athlete@example.com' } },
      }),
      onAuthStateChange: jest.fn().mockReturnValue({
        data: { subscription: { unsubscribe: jest.fn() } },
      }),
    },
    from: jest.fn(() => ({
      select: jest.fn().mockReturnThis(),
      eq: jest.fn().mockReturnThis(),
      single: jest.fn().mockResolvedValue({ data: { role: 'athlete' }, error: null }),
    })),
  })),
}));

let mockDealsData: Deal[] = [...mockDeals];
let mockDealsError: Error | null = null;
let mockDealsLoading = false;

jest.mock('@/lib/hooks/use-data', () => ({
  useAthleteDeals: jest.fn(() => ({
    data: mockDealsData,
    loading: mockDealsLoading,
    error: mockDealsError,
    refetch: jest.fn().mockResolvedValue(undefined),
  })),
}));

jest.mock('@/context', () => ({
  useRequireAuth: jest.fn(() => ({
    user: { id: 'athlete-1', email: 'athlete@example.com', role: 'athlete' },
    profile: {
      id: 'athlete-1',
      email: 'athlete@example.com',
      first_name: 'John',
      last_name: 'Doe',
      role: 'athlete',
    },
    roleData: { id: 'athlete-1', profile_id: 'athlete-1' },
    isLoading: false,
    isAuthenticated: true,
    error: null,
  })),
}));

// ═══════════════════════════════════════════════════════════════════════════
// Test Utilities
// ═══════════════════════════════════════════════════════════════════════════

function TestWrapper({ children }: { children: React.ReactNode }) {
  return <ToastProvider>{children}</ToastProvider>;
}

function renderWithProviders(component: React.ReactElement) {
  return render(component, { wrapper: TestWrapper });
}

function resetMocks() {
  mockDealsData = [...mockDeals];
  mockDealsError = null;
  mockDealsLoading = false;
  mockPush.mockClear();
  mockReplace.mockClear();
}

// ═══════════════════════════════════════════════════════════════════════════
// Tests
// ═══════════════════════════════════════════════════════════════════════════

describe('Athlete Deals Page', () => {
  beforeEach(() => {
    jest.clearAllMocks();
    resetMocks();
  });

  describe('Page Rendering', () => {
    it('renders the page header', async () => {
      renderWithProviders(<AthleteDealsPage />);

      await waitFor(() => {
        expect(screen.getByRole('heading', { name: /my deals/i })).toBeInTheDocument();
        expect(screen.getByText(/manage your nil partnerships/i)).toBeInTheDocument();
      });
    });

    it('renders view toggle buttons', async () => {
      renderWithProviders(<AthleteDealsPage />);

      await waitFor(() => {
        expect(screen.getByRole('button', { name: /table/i })).toBeInTheDocument();
        expect(screen.getByRole('button', { name: /kanban/i })).toBeInTheDocument();
      });
    });

    it('renders search input', async () => {
      renderWithProviders(<AthleteDealsPage />);

      await waitFor(() => {
        expect(screen.getByPlaceholderText(/search deals/i)).toBeInTheDocument();
      });
    });

    it('renders filter dropdowns', async () => {
      renderWithProviders(<AthleteDealsPage />);

      await waitFor(() => {
        expect(screen.getByText('Status')).toBeInTheDocument();
        expect(screen.getByText('Deal Type')).toBeInTheDocument();
      });
    });
  });

  describe('Deal Statistics', () => {
    it('displays incoming deals count', async () => {
      renderWithProviders(<AthleteDealsPage />);

      await waitFor(() => {
        expect(screen.getByText('Incoming')).toBeInTheDocument();
        // 1 pending deal in mock data
        expect(screen.getByText('1')).toBeInTheDocument();
      });
    });

    it('displays negotiating deals count', async () => {
      renderWithProviders(<AthleteDealsPage />);

      await waitFor(() => {
        expect(screen.getByText('Negotiating')).toBeInTheDocument();
      });
    });

    it('displays active deals count', async () => {
      renderWithProviders(<AthleteDealsPage />);

      await waitFor(() => {
        expect(screen.getByText('Active')).toBeInTheDocument();
      });
    });

    it('displays completed deals count', async () => {
      renderWithProviders(<AthleteDealsPage />);

      await waitFor(() => {
        expect(screen.getByText('Completed')).toBeInTheDocument();
      });
    });
  });

  describe('Table View', () => {
    it('defaults to table view', async () => {
      renderWithProviders(<AthleteDealsPage />);

      await waitFor(() => {
        const tableButton = screen.getByRole('button', { name: /table/i });
        expect(tableButton.className).toContain('bg-[var(--bg-card)]');
      });
    });

    it('displays deals in table format', async () => {
      renderWithProviders(<AthleteDealsPage />);

      await waitFor(() => {
        expect(screen.getByText('Nike Social Campaign')).toBeInTheDocument();
        expect(screen.getByText('Gatorade Event Appearance')).toBeInTheDocument();
        expect(screen.getByText('Local Dealership Promo')).toBeInTheDocument();
      });
    });

    it('displays brand names', async () => {
      renderWithProviders(<AthleteDealsPage />);

      await waitFor(() => {
        expect(screen.getByText('Nike')).toBeInTheDocument();
        expect(screen.getByText('Gatorade')).toBeInTheDocument();
        expect(screen.getByText('Durham Auto')).toBeInTheDocument();
      });
    });

    it('displays formatted currency amounts', async () => {
      renderWithProviders(<AthleteDealsPage />);

      await waitFor(() => {
        expect(screen.getByText('$5,000')).toBeInTheDocument();
        expect(screen.getByText('$2,500')).toBeInTheDocument();
        expect(screen.getByText('$1,500')).toBeInTheDocument();
      });
    });

    it('displays deal type badges', async () => {
      renderWithProviders(<AthleteDealsPage />);

      await waitFor(() => {
        expect(screen.getAllByText(/social/i).length).toBeGreaterThan(0);
        expect(screen.getAllByText(/appearance/i).length).toBeGreaterThan(0);
      });
    });

    it('displays view buttons for each deal', async () => {
      renderWithProviders(<AthleteDealsPage />);

      await waitFor(() => {
        const viewButtons = screen.getAllByRole('button', { name: /view/i });
        expect(viewButtons.length).toBe(mockDeals.length);
      });
    });
  });

  describe('Kanban View', () => {
    it('switches to kanban view when clicking kanban button', async () => {
      const user = userEvent.setup();
      renderWithProviders(<AthleteDealsPage />);

      await waitFor(() => {
        expect(screen.getByRole('button', { name: /kanban/i })).toBeInTheDocument();
      });

      const kanbanButton = screen.getByRole('button', { name: /kanban/i });
      await user.click(kanbanButton);

      await waitFor(() => {
        expect(kanbanButton.className).toContain('bg-[var(--bg-card)]');
      });
    });

    it('displays kanban columns with headers', async () => {
      const user = userEvent.setup();
      renderWithProviders(<AthleteDealsPage />);

      const kanbanButton = screen.getByRole('button', { name: /kanban/i });
      await user.click(kanbanButton);

      await waitFor(() => {
        // Kanban columns exist
        expect(screen.getAllByText(/pending/i).length).toBeGreaterThanOrEqual(1);
        expect(screen.getAllByText(/active/i).length).toBeGreaterThanOrEqual(1);
        expect(screen.getAllByText(/completed/i).length).toBeGreaterThanOrEqual(1);
      });
    });

    it('displays deal cards in kanban view', async () => {
      const user = userEvent.setup();
      renderWithProviders(<AthleteDealsPage />);

      const kanbanButton = screen.getByRole('button', { name: /kanban/i });
      await user.click(kanbanButton);

      await waitFor(() => {
        expect(screen.getByText('Nike Social Campaign')).toBeInTheDocument();
        expect(screen.getByText('Gatorade Event Appearance')).toBeInTheDocument();
      });
    });

    it('navigates to deal detail when clicking kanban card', async () => {
      const user = userEvent.setup();
      renderWithProviders(<AthleteDealsPage />);

      const kanbanButton = screen.getByRole('button', { name: /kanban/i });
      await user.click(kanbanButton);

      await waitFor(() => {
        expect(screen.getByRole('button', { name: /view deal: nike social campaign/i })).toBeInTheDocument();
      });

      const dealCard = screen.getByRole('button', { name: /view deal: nike social campaign/i });
      await user.click(dealCard);

      await waitFor(() => {
        expect(mockPush).toHaveBeenCalledWith('/athlete/deals/deal-1');
      });
    });
  });

  describe('Search and Filtering', () => {
    it('filters deals by search query (title)', async () => {
      const user = userEvent.setup();
      renderWithProviders(<AthleteDealsPage />);

      await waitFor(() => {
        expect(screen.getByText('Nike Social Campaign')).toBeInTheDocument();
      });

      const searchInput = screen.getByPlaceholderText(/search deals/i);
      await user.type(searchInput, 'Nike');

      await waitFor(() => {
        expect(screen.getByText('Nike Social Campaign')).toBeInTheDocument();
        expect(screen.queryByText('Gatorade Event Appearance')).not.toBeInTheDocument();
      });
    });

    it('filters deals by brand name', async () => {
      const user = userEvent.setup();
      renderWithProviders(<AthleteDealsPage />);

      const searchInput = screen.getByPlaceholderText(/search deals/i);
      await user.type(searchInput, 'Gatorade');

      await waitFor(() => {
        expect(screen.getByText('Gatorade Event Appearance')).toBeInTheDocument();
        expect(screen.queryByText('Nike Social Campaign')).not.toBeInTheDocument();
      });
    });

    it('shows empty state when no deals match filter', async () => {
      const user = userEvent.setup();
      renderWithProviders(<AthleteDealsPage />);

      const searchInput = screen.getByPlaceholderText(/search deals/i);
      await user.type(searchInput, 'NonexistentBrand');

      await waitFor(() => {
        expect(screen.getByText(/no deals found/i)).toBeInTheDocument();
      });
    });

    it('shows clear filters action in filtered empty state', async () => {
      const user = userEvent.setup();
      renderWithProviders(<AthleteDealsPage />);

      const searchInput = screen.getByPlaceholderText(/search deals/i);
      await user.type(searchInput, 'NonexistentBrand');

      await waitFor(() => {
        // Look for clear filters button
        const clearButton = screen.queryByRole('button', { name: /clear filters/i });
        if (clearButton) {
          expect(clearButton).toBeInTheDocument();
        } else {
          expect(screen.getByText(/try adjusting your filters/i)).toBeInTheDocument();
        }
      });
    });

    it('clears search when clearing input', async () => {
      const user = userEvent.setup();
      renderWithProviders(<AthleteDealsPage />);

      const searchInput = screen.getByPlaceholderText(/search deals/i);
      await user.type(searchInput, 'Nike');

      await waitFor(() => {
        expect(screen.queryByText('Gatorade Event Appearance')).not.toBeInTheDocument();
      });

      await user.clear(searchInput);

      await waitFor(() => {
        expect(screen.getByText('Nike Social Campaign')).toBeInTheDocument();
        expect(screen.getByText('Gatorade Event Appearance')).toBeInTheDocument();
      });
    });
  });

  describe('Navigation', () => {
    it('navigates to deal detail when clicking view button', async () => {
      const user = userEvent.setup();
      renderWithProviders(<AthleteDealsPage />);

      await waitFor(() => {
        expect(screen.getByText('Nike Social Campaign')).toBeInTheDocument();
      });

      const viewButtons = screen.getAllByRole('button', { name: /view/i });
      await user.click(viewButtons[0]);

      await waitFor(() => {
        expect(mockPush).toHaveBeenCalledWith('/athlete/deals/deal-1');
      });
    });

    it('navigates to deal detail when clicking row', async () => {
      const user = userEvent.setup();
      renderWithProviders(<AthleteDealsPage />);

      await waitFor(() => {
        expect(screen.getByText('Nike Social Campaign')).toBeInTheDocument();
      });

      const dealTitle = screen.getByText('Nike Social Campaign');
      const dealRow = dealTitle.closest('tr') || dealTitle.closest('[role="row"]');

      if (dealRow) {
        await user.click(dealRow);

        await waitFor(() => {
          expect(mockPush).toHaveBeenCalled();
        });
      }
    });
  });

  describe('Empty State', () => {
    it('shows empty state when no deals exist', async () => {
      mockDealsData = [];

      renderWithProviders(<AthleteDealsPage />);

      await waitFor(() => {
        expect(screen.getByText(/no deals found/i)).toBeInTheDocument();
        expect(screen.getByText(/you do not have any deals yet/i)).toBeInTheDocument();
      });
    });

    it('does not show clear filters for natural empty state', async () => {
      mockDealsData = [];

      renderWithProviders(<AthleteDealsPage />);

      await waitFor(() => {
        expect(screen.getByText(/no deals found/i)).toBeInTheDocument();
        expect(screen.queryByRole('button', { name: /clear filters/i })).not.toBeInTheDocument();
      });
    });
  });

  describe('Error Handling', () => {
    it('shows error state when data fetch fails', async () => {
      mockDealsData = [];
      mockDealsError = new Error('Failed to fetch deals');

      renderWithProviders(<AthleteDealsPage />);

      await waitFor(() => {
        expect(screen.getByText(/failed to load deals/i)).toBeInTheDocument();
      });
    });

    it('shows retry button in error state', async () => {
      mockDealsData = [];
      mockDealsError = new Error('Failed to fetch deals');

      renderWithProviders(<AthleteDealsPage />);

      await waitFor(() => {
        expect(screen.getByRole('button', { name: /try again/i })).toBeInTheDocument();
      });
    });

    it('displays error message', async () => {
      mockDealsData = [];
      mockDealsError = new Error('Network connection lost');

      renderWithProviders(<AthleteDealsPage />);

      await waitFor(() => {
        expect(screen.getByText(/network connection lost/i)).toBeInTheDocument();
      });
    });
  });

  describe('View Toggle', () => {
    it('switches from table to kanban and back', async () => {
      const user = userEvent.setup();
      renderWithProviders(<AthleteDealsPage />);

      // Start in table view
      await waitFor(() => {
        const tableButton = screen.getByRole('button', { name: /table/i });
        expect(tableButton.className).toContain('bg-[var(--bg-card)]');
      });

      // Switch to kanban
      const kanbanButton = screen.getByRole('button', { name: /kanban/i });
      await user.click(kanbanButton);

      await waitFor(() => {
        expect(kanbanButton.className).toContain('bg-[var(--bg-card)]');
      });

      // Switch back to table
      const tableButton = screen.getByRole('button', { name: /table/i });
      await user.click(tableButton);

      await waitFor(() => {
        expect(tableButton.className).toContain('bg-[var(--bg-card)]');
      });
    });
  });

  describe('Accessibility', () => {
    it('has accessible heading structure', async () => {
      renderWithProviders(<AthleteDealsPage />);

      await waitFor(() => {
        const heading = screen.getByRole('heading', { level: 1 });
        expect(heading).toHaveTextContent(/my deals/i);
      });
    });

    it('kanban cards have accessible labels', async () => {
      const user = userEvent.setup();
      renderWithProviders(<AthleteDealsPage />);

      const kanbanButton = screen.getByRole('button', { name: /kanban/i });
      await user.click(kanbanButton);

      await waitFor(() => {
        const nikeCard = screen.getByRole('button', { name: /view deal: nike social campaign/i });
        expect(nikeCard).toBeInTheDocument();
      });
    });

    it('search input is accessible', async () => {
      renderWithProviders(<AthleteDealsPage />);

      await waitFor(() => {
        const searchInput = screen.getByPlaceholderText(/search deals/i);
        expect(searchInput).toBeInTheDocument();
      });
    });
  });
});
