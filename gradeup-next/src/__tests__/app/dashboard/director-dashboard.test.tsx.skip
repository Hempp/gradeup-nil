/**
 * Tests: Director Dashboard Page
 *
 * Tests cover:
 * - Page rendering and layout
 * - Stats cards display
 * - School athletes section
 * - Compliance alerts panel
 * - Alert detail modal
 * - Loading and error states
 */

import { render, screen, waitFor } from '@testing-library/react';
import userEvent from '@testing-library/user-event';
import DirectorDashboardPage from '@/app/(dashboard)/director/dashboard/page';
import { ToastProvider } from '@/components/ui/toast';
import type { ComplianceAlert } from '@/lib/services/director';

// ═══════════════════════════════════════════════════════════════════════════
// Mock Data
// ═══════════════════════════════════════════════════════════════════════════

const mockStats = {
  total_athletes: 150,
  active_deals: 45,
  total_earnings: 250000,
  avg_gpa: 3.45,
  verified_athletes: 120,
  pending_verifications: 8,
};

const mockAthletes = {
  athletes: [
    {
      id: 'athlete-1',
      first_name: 'John',
      last_name: 'Smith',
      gpa: 3.8,
      position: 'Point Guard',
      sport: { name: 'Basketball' },
    },
    {
      id: 'athlete-2',
      first_name: 'Jane',
      last_name: 'Doe',
      gpa: 3.9,
      position: 'Forward',
      sport: { name: 'Soccer' },
    },
    {
      id: 'athlete-3',
      first_name: 'Mike',
      last_name: 'Johnson',
      gpa: 3.5,
      position: 'Quarterback',
      sport: { name: 'Football' },
    },
  ],
};

const mockAlerts: ComplianceAlert[] = [
  {
    id: 'alert-1',
    athlete_id: 'athlete-1',
    athlete_name: 'John Smith',
    type: 'deal_review',
    message: 'Deal amount exceeds $10,000 threshold',
    severity: 'high',
    created_at: '2026-02-14T10:00:00Z',
  },
  {
    id: 'alert-2',
    athlete_id: 'athlete-2',
    athlete_name: 'Jane Doe',
    type: 'gpa_drop',
    message: 'GPA verification pending for new deal',
    severity: 'medium',
    created_at: '2026-02-13T15:30:00Z',
  },
  {
    id: 'alert-3',
    athlete_id: 'athlete-3',
    athlete_name: 'Mike Johnson',
    type: 'deal_review',
    message: 'Deal with new brand requires review',
    severity: 'low',
    created_at: '2026-02-12T09:15:00Z',
  },
];

// ═══════════════════════════════════════════════════════════════════════════
// Mocks
// ═══════════════════════════════════════════════════════════════════════════

const mockPush = jest.fn();

jest.mock('next/navigation', () => ({
  useRouter: () => ({
    push: mockPush,
    replace: jest.fn(),
    prefetch: jest.fn(),
  }),
  usePathname: () => '/director/dashboard',
  useSearchParams: () => new URLSearchParams(),
}));

jest.mock('next/link', () => {
  return function Link({ children, href }: { children: React.ReactNode; href: string }) {
    return <a href={href}>{children}</a>;
  };
});

jest.mock('@/lib/supabase/client', () => ({
  createClient: jest.fn(() => ({
    auth: {
      getSession: jest.fn().mockResolvedValue({
        data: { session: { user: { id: 'director-1', email: 'director@example.com' } } },
      }),
      getUser: jest.fn().mockResolvedValue({
        data: { user: { id: 'director-1', email: 'director@example.com' } },
      }),
      onAuthStateChange: jest.fn().mockReturnValue({
        data: { subscription: { unsubscribe: jest.fn() } },
      }),
    },
    from: jest.fn(() => ({
      select: jest.fn().mockReturnThis(),
      eq: jest.fn().mockReturnThis(),
      single: jest.fn().mockResolvedValue({ data: { role: 'athletic_director' }, error: null }),
    })),
  })),
}));

let mockStatsData = { ...mockStats };
let mockStatsError: Error | null = null;
let mockStatsLoading = false;

let mockAthletesData = { ...mockAthletes };
let mockAthletesError: Error | null = null;
let mockAthletesLoading = false;

let mockAlertsData: ComplianceAlert[] = [...mockAlerts];
let mockAlertsError: Error | null = null;
let mockAlertsLoading = false;

jest.mock('@/lib/hooks/use-data', () => ({
  useDirectorStats: jest.fn(() => ({
    data: mockStatsData,
    loading: mockStatsLoading,
    error: mockStatsError,
    refetch: jest.fn().mockResolvedValue(undefined),
  })),
  useSchoolAthletes: jest.fn(() => ({
    data: mockAthletesData,
    loading: mockAthletesLoading,
    error: mockAthletesError,
    refetch: jest.fn().mockResolvedValue(undefined),
  })),
  useComplianceAlerts: jest.fn(() => ({
    data: mockAlertsData,
    loading: mockAlertsLoading,
    error: mockAlertsError,
    refetch: jest.fn().mockResolvedValue(undefined),
  })),
}));

jest.mock('@/context', () => ({
  useRequireAuth: jest.fn(() => ({
    user: { id: 'director-1', email: 'director@example.com', role: 'athletic_director' },
    profile: {
      id: 'director-1',
      email: 'director@example.com',
      first_name: 'Athletic',
      last_name: 'Director',
      role: 'athletic_director',
    },
    roleData: {
      id: 'director-1',
      school_id: 'school-1',
      school: { name: 'Duke University', short_name: 'Duke' },
    },
    isLoading: false,
    isAuthenticated: true,
    error: null,
  })),
}));

// ═══════════════════════════════════════════════════════════════════════════
// Test Utilities
// ═══════════════════════════════════════════════════════════════════════════

function TestWrapper({ children }: { children: React.ReactNode }) {
  return <ToastProvider>{children}</ToastProvider>;
}

function renderWithProviders(component: React.ReactElement) {
  return render(component, { wrapper: TestWrapper });
}

function resetMocks() {
  mockStatsData = { ...mockStats };
  mockStatsError = null;
  mockStatsLoading = false;
  mockAthletesData = { ...mockAthletes };
  mockAthletesError = null;
  mockAthletesLoading = false;
  mockAlertsData = [...mockAlerts];
  mockAlertsError = null;
  mockAlertsLoading = false;
  mockPush.mockClear();
}

// ═══════════════════════════════════════════════════════════════════════════
// Tests
// ═══════════════════════════════════════════════════════════════════════════

describe('Director Dashboard Page', () => {
  beforeEach(() => {
    jest.clearAllMocks();
    resetMocks();
  });

  describe('Page Rendering', () => {
    it('renders program overview heading', async () => {
      renderWithProviders(<DirectorDashboardPage />);

      await waitFor(() => {
        expect(screen.getByRole('heading', { name: /program overview/i })).toBeInTheDocument();
      });
    });

    it('renders school name in description', async () => {
      renderWithProviders(<DirectorDashboardPage />);

      await waitFor(() => {
        expect(screen.getByText(/duke university athletics nil program/i)).toBeInTheDocument();
      });
    });

    it('displays athletic director badge', async () => {
      renderWithProviders(<DirectorDashboardPage />);

      await waitFor(() => {
        expect(screen.getByText('Athletic Director')).toBeInTheDocument();
      });
    });
  });

  describe('Stats Cards', () => {
    it('displays total athletes stat', async () => {
      renderWithProviders(<DirectorDashboardPage />);

      await waitFor(() => {
        expect(screen.getByText('Total Athletes')).toBeInTheDocument();
        expect(screen.getByText('150')).toBeInTheDocument();
      });
    });

    it('displays active deals stat', async () => {
      renderWithProviders(<DirectorDashboardPage />);

      await waitFor(() => {
        expect(screen.getByText('Active Deals')).toBeInTheDocument();
        expect(screen.getByText('45')).toBeInTheDocument();
      });
    });

    it('displays total earnings stat', async () => {
      renderWithProviders(<DirectorDashboardPage />);

      await waitFor(() => {
        expect(screen.getByText('Total Earnings')).toBeInTheDocument();
        expect(screen.getByText('$250,000')).toBeInTheDocument();
      });
    });

    it('displays average GPA stat', async () => {
      renderWithProviders(<DirectorDashboardPage />);

      await waitFor(() => {
        expect(screen.getByText('Average GPA')).toBeInTheDocument();
        expect(screen.getByText('3.45')).toBeInTheDocument();
      });
    });

    it('displays verified athletes stat', async () => {
      renderWithProviders(<DirectorDashboardPage />);

      await waitFor(() => {
        expect(screen.getByText('Verified Athletes')).toBeInTheDocument();
        expect(screen.getByText('120')).toBeInTheDocument();
      });
    });

    it('displays pending verifications stat', async () => {
      renderWithProviders(<DirectorDashboardPage />);

      await waitFor(() => {
        expect(screen.getByText('Pending Verifications')).toBeInTheDocument();
        expect(screen.getByText('8')).toBeInTheDocument();
      });
    });

    it('shows loading indicators when stats are loading', async () => {
      mockStatsLoading = true;

      renderWithProviders(<DirectorDashboardPage />);

      await waitFor(() => {
        const loadingIndicators = screen.getAllByText('...');
        expect(loadingIndicators.length).toBeGreaterThan(0);
      });
    });
  });

  describe('School Athletes Section', () => {
    it('renders school athletes section', async () => {
      renderWithProviders(<DirectorDashboardPage />);

      await waitFor(() => {
        expect(screen.getByText('School Athletes')).toBeInTheDocument();
      });
    });

    it('displays athlete names', async () => {
      renderWithProviders(<DirectorDashboardPage />);

      await waitFor(() => {
        expect(screen.getByText('John Smith')).toBeInTheDocument();
        expect(screen.getByText('Jane Doe')).toBeInTheDocument();
        expect(screen.getByText('Mike Johnson')).toBeInTheDocument();
      });
    });

    it('displays athlete sports and positions', async () => {
      renderWithProviders(<DirectorDashboardPage />);

      await waitFor(() => {
        expect(screen.getByText(/basketball/i)).toBeInTheDocument();
        expect(screen.getByText(/point guard/i)).toBeInTheDocument();
        expect(screen.getByText(/soccer/i)).toBeInTheDocument();
      });
    });

    it('displays GPA badges', async () => {
      renderWithProviders(<DirectorDashboardPage />);

      await waitFor(() => {
        expect(screen.getByText('3.80 GPA')).toBeInTheDocument();
        expect(screen.getByText('3.90 GPA')).toBeInTheDocument();
        expect(screen.getByText('3.50 GPA')).toBeInTheDocument();
      });
    });

    it('shows view all link', async () => {
      renderWithProviders(<DirectorDashboardPage />);

      await waitFor(() => {
        const viewAllLink = screen.getByRole('link', { name: /view all/i });
        expect(viewAllLink).toHaveAttribute('href', '/director/athletes');
      });
    });

    it('shows empty state when no athletes', async () => {
      mockAthletesData = { athletes: [] };

      renderWithProviders(<DirectorDashboardPage />);

      await waitFor(() => {
        expect(screen.getByText(/no athletes registered yet/i)).toBeInTheDocument();
      });
    });

    it('shows loading state for athletes', async () => {
      mockAthletesLoading = true;

      renderWithProviders(<DirectorDashboardPage />);

      await waitFor(() => {
        expect(screen.getByText('School Athletes')).toBeInTheDocument();
        // Loading spinner should be present
      });
    });
  });

  describe('Compliance Alerts Section', () => {
    it('renders compliance alerts section', async () => {
      renderWithProviders(<DirectorDashboardPage />);

      await waitFor(() => {
        expect(screen.getByText('Compliance Alerts')).toBeInTheDocument();
      });
    });

    it('displays active alerts count badge', async () => {
      renderWithProviders(<DirectorDashboardPage />);

      await waitFor(() => {
        expect(screen.getByText('3 Active')).toBeInTheDocument();
      });
    });

    it('displays alert athlete names', async () => {
      renderWithProviders(<DirectorDashboardPage />);

      await waitFor(() => {
        // Alert names in the alerts panel
        const alertPanel = screen.getByText('Compliance Alerts').closest('div');
        expect(alertPanel).toBeInTheDocument();
        expect(screen.getAllByText('John Smith').length).toBeGreaterThanOrEqual(1);
      });
    });

    it('displays alert messages', async () => {
      renderWithProviders(<DirectorDashboardPage />);

      await waitFor(() => {
        expect(screen.getByText(/deal amount exceeds \$10,000 threshold/i)).toBeInTheDocument();
        expect(screen.getByText(/gpa verification pending/i)).toBeInTheDocument();
      });
    });

    it('displays severity badges', async () => {
      renderWithProviders(<DirectorDashboardPage />);

      await waitFor(() => {
        expect(screen.getByText('High')).toBeInTheDocument();
        expect(screen.getByText('Medium')).toBeInTheDocument();
        expect(screen.getByText('Low')).toBeInTheDocument();
      });
    });

    it('displays view buttons for each alert', async () => {
      renderWithProviders(<DirectorDashboardPage />);

      await waitFor(() => {
        const viewButtons = screen.getAllByRole('button', { name: /view/i });
        expect(viewButtons.length).toBe(3);
      });
    });

    it('shows empty state when no alerts', async () => {
      mockAlertsData = [];

      renderWithProviders(<DirectorDashboardPage />);

      await waitFor(() => {
        expect(screen.getByText(/no compliance alerts/i)).toBeInTheDocument();
      });
    });

    it('shows loading state for alerts', async () => {
      mockAlertsLoading = true;

      renderWithProviders(<DirectorDashboardPage />);

      await waitFor(() => {
        expect(screen.getByText('Compliance Alerts')).toBeInTheDocument();
        // Loading spinner should be present
      });
    });
  });

  describe('Alert Detail Modal', () => {
    it('opens modal when clicking view button on alert', async () => {
      const user = userEvent.setup();
      renderWithProviders(<DirectorDashboardPage />);

      await waitFor(() => {
        expect(screen.getByText(/deal amount exceeds/i)).toBeInTheDocument();
      });

      const viewButtons = screen.getAllByRole('button', { name: /view/i });
      await user.click(viewButtons[0]);

      await waitFor(() => {
        expect(screen.getByText('Alert Details')).toBeInTheDocument();
      });
    });

    it('displays alert details in modal', async () => {
      const user = userEvent.setup();
      renderWithProviders(<DirectorDashboardPage />);

      const viewButtons = screen.getAllByRole('button', { name: /view/i });
      await user.click(viewButtons[0]);

      await waitFor(() => {
        expect(screen.getByText('Alert Message')).toBeInTheDocument();
        expect(screen.getByText('High Priority')).toBeInTheDocument();
      });
    });

    it('displays go to compliance center button in modal', async () => {
      const user = userEvent.setup();
      renderWithProviders(<DirectorDashboardPage />);

      const viewButtons = screen.getAllByRole('button', { name: /view/i });
      await user.click(viewButtons[0]);

      await waitFor(() => {
        expect(screen.getByRole('button', { name: /go to compliance center/i })).toBeInTheDocument();
      });
    });

    it('closes modal when clicking close button', async () => {
      const user = userEvent.setup();
      renderWithProviders(<DirectorDashboardPage />);

      const viewButtons = screen.getAllByRole('button', { name: /view/i });
      await user.click(viewButtons[0]);

      await waitFor(() => {
        expect(screen.getByText('Alert Details')).toBeInTheDocument();
      });

      const closeButton = screen.getByRole('button', { name: /close/i });
      await user.click(closeButton);

      await waitFor(() => {
        expect(screen.queryByText('Alert Details')).not.toBeInTheDocument();
      });
    });

    it('navigates to compliance center when clicking button', async () => {
      const user = userEvent.setup();
      renderWithProviders(<DirectorDashboardPage />);

      const viewButtons = screen.getAllByRole('button', { name: /view/i });
      await user.click(viewButtons[0]);

      await waitFor(() => {
        expect(screen.getByRole('button', { name: /go to compliance center/i })).toBeInTheDocument();
      });

      const complianceButton = screen.getByRole('button', { name: /go to compliance center/i });
      await user.click(complianceButton);

      await waitFor(() => {
        expect(mockPush).toHaveBeenCalledWith('/director/compliance');
      });
    });
  });

  describe('Error Handling', () => {
    it('shows error state when data fetch fails', async () => {
      mockStatsError = new Error('Failed to fetch stats');

      renderWithProviders(<DirectorDashboardPage />);

      await waitFor(() => {
        expect(screen.getByText(/failed to load dashboard/i)).toBeInTheDocument();
      });
    });

    it('shows retry button in error state', async () => {
      mockStatsError = new Error('Failed to fetch');

      renderWithProviders(<DirectorDashboardPage />);

      await waitFor(() => {
        expect(screen.getByRole('button', { name: /try again/i })).toBeInTheDocument();
      });
    });

    it('displays error message from any failed service', async () => {
      mockAlertsError = new Error('Compliance service unavailable');

      renderWithProviders(<DirectorDashboardPage />);

      await waitFor(() => {
        expect(screen.getByText(/failed to load dashboard/i)).toBeInTheDocument();
      });
    });
  });

  describe('Loading States', () => {
    it('shows loading spinner when auth is loading', async () => {
      const mockUseRequireAuth = jest.requireMock('@/context').useRequireAuth;
      mockUseRequireAuth.mockReturnValueOnce({
        user: null,
        profile: null,
        roleData: null,
        isLoading: true,
        isAuthenticated: false,
        error: null,
      });

      renderWithProviders(<DirectorDashboardPage />);

      await waitFor(() => {
        const spinners = document.querySelectorAll('.animate-spin');
        expect(spinners.length).toBeGreaterThan(0);
      });
    });
  });

  describe('Accessibility', () => {
    it('has accessible heading structure', async () => {
      renderWithProviders(<DirectorDashboardPage />);

      await waitFor(() => {
        const heading = screen.getByRole('heading', { level: 1 });
        expect(heading).toHaveTextContent(/program overview/i);
      });
    });

    it('modal has accessible title', async () => {
      const user = userEvent.setup();
      renderWithProviders(<DirectorDashboardPage />);

      const viewButtons = screen.getAllByRole('button', { name: /view/i });
      await user.click(viewButtons[0]);

      await waitFor(() => {
        expect(screen.getByRole('heading', { name: /alert details/i })).toBeInTheDocument();
      });
    });

    it('alert view buttons have accessible labels', async () => {
      renderWithProviders(<DirectorDashboardPage />);

      await waitFor(() => {
        const viewButtons = screen.getAllByRole('button', { name: /view/i });
        viewButtons.forEach(button => {
          expect(button).toBeInTheDocument();
        });
      });
    });

    it('links have href attributes', async () => {
      renderWithProviders(<DirectorDashboardPage />);

      await waitFor(() => {
        const viewAllLink = screen.getByRole('link', { name: /view all/i });
        expect(viewAllLink).toHaveAttribute('href');
      });
    });
  });

  describe('Severity Colors', () => {
    it('high severity alerts have error styling', async () => {
      renderWithProviders(<DirectorDashboardPage />);

      await waitFor(() => {
        const highBadge = screen.getByText('High');
        expect(highBadge).toBeInTheDocument();
      });
    });

    it('medium severity alerts have warning styling', async () => {
      renderWithProviders(<DirectorDashboardPage />);

      await waitFor(() => {
        const mediumBadge = screen.getByText('Medium');
        expect(mediumBadge).toBeInTheDocument();
      });
    });

    it('low severity alerts have primary styling', async () => {
      renderWithProviders(<DirectorDashboardPage />);

      await waitFor(() => {
        const lowBadge = screen.getByText('Low');
        expect(lowBadge).toBeInTheDocument();
      });
    });
  });
});
